<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<th:block
	th:replace="~{./include/layout :: layout(~{:: .main-wrapper})}">

	<div class="main-wrapper">

		<h2 style="margin-top: 20px; margin-bottom: 20px;">
			[[${list[0].teamNo}]]팀 관리창</h2>

		<hr />
		
		<div class="currentWrap">
		
			<div class="currentList">
			
				<div class="currentTitle">
					• [[${list[0].teamNo}]]팀 태스크 현황
				</div>
				
				<div class="listWrap">
					
					
					<div class="currentCard" th:each="voo, status : ${lists}">
						<div class="cardText">
							<div class="cardTextDetail">
								<p style="font-size: 14px; font-weight: 600; padding-bottom: 3px; border-bottom: 1px #a39485 solid;">팀명</p>
								<p style="font-size: 12px; padding-top: 5px;">[[${voo.teamName}]]</p>
							</div>
							<div class="cardTextDetail">
								<p style="font-size: 14px; font-weight: 600; padding-bottom: 3px; border-bottom: 1px #a39485 solid;">총 태스크 수</p>
								<p style="font-size: 12px; padding-top: 5px;">[[${voo.taskCount}]]건</p>
							</div>
							<div class="cardTextDetail">
								<p style="font-size: 13px; font-weight: 600; padding-bottom: 3px; border-bottom: 1px #a39485 solid;">프로젝트 종료까지 남은 기간</p>
								<p style="font-size: 12px; padding-top: 5px;">[[${voo.remain}]]일</p>
							</div>
							<div class="cardTextDetail">
								<p style="font-size: 14px; font-weight: 600; padding-bottom: 3px; border-bottom: 1px #a39485 solid;">팀 인원</p>
								<p style="font-size: 12px; padding-top: 5px;">[[${voo.teamCount}]]명</p>
							</div>
						</div>
						<div class="cardChart">
							<div class="cardChartTitle">
								• 태스크 현황
							</div> 
							
						</div>
					</div>
					
					
					
					
				</div>
				
			</div>
		<table>
			`
			<thead>
				<tr>
					<th>이름</th>
					<th>닉네임</th>
					<th>이메일</th>
					<th>생년월일</th>
					<th>유저권한</th>
					<th>추가/삭제</th>
				</tr>
			</thead>
			<tbody class="tablebodys">


				<tr class="trbodys" th:each=" vo, status : ${list}">
					<td>[[${vo.userName}]]</td>
					<td>[[${vo.nickName}]]</td>
					<td class="userEmail">[[${vo.userEmail}]]</td>
					<td>[[${vo.birth}]]</td>
					<td class ="cc" th:if="${vo.is_same == 'T'} and ${vo.role == 0}">팀장</td>

					<td class ="bb" th:unless="${vo.is_same == 'T'} and ${vo.role == 0}">
						<select class="selrole">
							<option th:selected="${vo.role == 0}">팀원</option>
							<option th:selected="${vo.role == 1}">옵저버</option>
						</select>
					</td>
					
					<td>
   				 		<button th:if="${vo.is_same != 'T'}" type="button" class="btn_del" th:value="${vo.userEmail}">삭제</button>
    					<button th:unless="${vo.is_same != 'T'}" class="btn-open-popup">팀원추가</button>
					</td>
					<input class="tnodate" type="hidden" th:value=${vo.teamNo}>
				</tr>
			</tbody>

		</table>

		<div class="modal">

			<div class="modal_body">
				<h4>추가할 인원</h4>
				<input type="text" class="modalSearch">
				<div class="modalbodys">
					<div class="modaltop"></div>
				</div>
			</div>
		</div>
		
		
		
		</div>
</th:block>





<script th:inline="javascript">
	
var chartList = JSON.parse('[[${lists}]]');
var cardList = document.querySelectorAll('.cardChart');

chartList.forEach((chart, idx) => {
	
	// 1. canvas 태그 세팅
	var tag = document.createElement('canvas');
	tag.id = 'doughnutChart'+idx;
	tag.style.height = '200px';
	tag.style.width = '200px';
	tag.style.marginTop = '20px';
	
	// 2. chart 영역에 추가
	cardList[idx].appendChild(tag);
	
	// 3. 추가 후에 chart데이터 세팅
	var total = chart.taskCount;
	var progress = chart.progress == 0 ? 0 : (chart.progress/total)*100;
	var unprogress = chart.unprogress == 0 ? 0: (chart.unprogress/total)*100
	var complete = chart.complete == 0 ? 0: (chart.complete/total)*100;
	
	var ctx = document.getElementById('doughnutChart'+idx);
	var doughnutChart = new Chart(ctx, {
		  type: 'doughnut',
		    data: {
		      labels: ['완료', '진행예정', '진행중'],
		      datasets: [{
		        data: [progress, unprogress, complete],     
		        backgroundColor: [
		          'rgba(157, 206, 255, 0.8)',
		          'rgba(206, 226, 197, 0.8)',
		          'rgba(251, 197, 197, 0.8)',
		        ],
		        borderWidth: 0.5,
		        scaleBeginAtZero: true,
		      }
		    ]
		  },
		  options: {
		    	responsive: false,
		    	plugins:{
			        legend: {
			        	display: true,
			        	align: 'center',
			        	reverse: true,
			        	labels: {
			        		padding: 3,
			        		boxWidth: 10,
			        	}
			        },
		        }    
		    }
		});
	
}); 


	$('.selrole').change(function(e) {
		
		 var role = $(e.target).val() == "팀원" ? 0 : 1;
		 var userEmail = $(this).parent().siblings('.userEmail').html();
		 var teamNo = $('.tnodate').eq(0).val();
		
		
	  $.ajax({
			 url: "/updateRole",
			 type : "post",
			 data :{
				 role : role,
				 userEmail :userEmail,
				 teamNo : teamNo
			 },
			 success:function(result){
				 
				 alert(result);
				 
			 },error: function(err){
	            	console.log("에러");
	            }
		 }) 
	})

$('.tablebodys').on('click','.btn_del',function(e){
	if(confirm("정말로 삭제하시겠습니까?")){
		
		var userEmail = e.target.value;
		var teamNo = $('.tnodate').eq(0).val();
		
			 $.ajax({
				
				url: "/deleteTeam",
	            type: "post",
	            data: {
	            	 userEmail : userEmail
	            },
	            success: function(result) {
	               alert(result);
	               
	               $.ajax({
	   				
	   				url: "/teamListUpdate",
	   	            type: "post",
	   	            data: {
	   	            	 teamNo : teamNo
	   	            },
	   	            success: function(result){
	   	            	regetBodyLists(result);
	   	            }
	   	            	, error: function(err){
	   	            	console.log("에러");
	   	            }
	   			})  
	               
	            }, error: function(err){
	            	console.log("에러");
	            }
			}) 
	}
	
		})
	
$('.modal').on('keyup','input',function(e){
	
	var searchId = e.target.value;
	var teamNo = $(".tnodate").val();
	if(searchId ==''){
		$(".userEmail").remove();
		var str = "";
			str += "<tr class = 'trbodys'>";
			str += "</tr>";
			 $(".modalbodys").html(str);
		return;
	} 
	
	$.ajax({
			
			url: "/searchId",
           type: "post",
           data: {
           	 searchId : searchId,
           	 teamNo : teamNo
           },
           success: function(result) {
        	   
        	  	regetList(result);
           }
        	   , error: function(err){
           	console.log("에러");
           }
	
		}) 
	
});



$('.modalbodys').on('click','button',function(e){
	var userEmail = e.target.value;
	console.log(userEmail);
	var teamNo = $(".tnodate").val();
	console.log("팀번호" +teamNo);
	
	var role = $(".role").val();
	console.log(role);
	
	var searchId = $(".modalSearch").val();
	console.log(searchId);
	
	 $.ajax({
		
		url: "/insertTeam",
       type: "post",
       data: {
       	 userEmail : userEmail ,
       	 teamNo : teamNo ,
       	 role : role ,
       	 searchId : searchId
       },
       success: function(result) {
    	   alert("추가성공");
    	  regetList(result);
    	   
    	  /*  $.ajax({
    		   
    	   }) */
       
       }, error: function(err){
       	console.log("추가에러");
       } 

	}) 
});
		
var modal = document.querySelector('.modal');
var btnOpenPopup = document.querySelector('.btn-open-popup');

btnOpenPopup.addEventListener('click', () => {
  modal.style.display = 'block';
});

modal.addEventListener('click', (event) => {
	  if (event.target === modal) {
		  modal.style.display = 'none';
		  $(".modalSearch").val('');
		  var teamNo = $(".tnodate").val();
		 $.ajax({
			 url: "/teamListUpdate",
			 type: "post",
			 data: {
				 teamNo : teamNo
			 },
		 success: function(result) {
	    	  regetBodyLists(result);
	    	   
	       }, error: function(err){
	       	console.log("추가에러");
	       } 
		 
		 })
	  }
	});

function regetList(result){
 	   var str = "";
 	   str += '<table><thead><tr><th>이메일</th><th>이름</th><th>닉네임</th><th>권한</th><th></th><th></th></tr></thead>';
 	   for(var i = 0; i<result.length; i++){
           	str += "<tr class = 'trbodys'>";
				str +=	 '<td class ="userEmail">' + result[i].userEmail + '</td>';
				str +=	 '<td>' + result[i].userName + '</td>';
				str +=	 '<td>' + result[i].nickName + '</td>';
				str += '<td><select class ="role"><option value = 0>팀원</option><option value = 1>옵저버</option></select></td>';
				str += '<td><button type ="button" class ="btn btn-success" value ='  + result[i].userEmail + '>추가</button></td>';
				str += ' <input class ="tnodate" type = "hidden" value = ' + result[i].userEmail +'>'
				str += "</tr>";
            }
 	   $(".modalbodys").html(str);
}

function regetBodyLists(result) {
   	var str = "";
    for(var i = 0; i<result.length; i++){
   	str += "<tr class = 'trbodys'>";
   	str += '<td>'+ result[i].userName +'</td>';
		str +=	 '<td>' + result[i].nickName +'</td>';
		str +=	 '<td class ="userEmail">' + result[i].userEmail + '</td>';
		str +=	 '<td>' + result[i].birth + '</td>';
		if(result[i].is_same == "T" && result[i].role == 0){
		str +=  '<td>팀장</td>';
		}else{
			str += '<td><select class="selrole"><option' + (result[i].role == 1 ? ' selected' : '') + '>옵저버</option><option' + (result[i].role == 0 ? ' selected' : '') + '>팀원</option></select></td>';

		}
		if(result[i].is_same == "F"){
		str += '<td if = "${vo.is_same != T}"><button type ="button" class ="btn_del" value ='  + result[i].userEmail + '>삭제</button></td>';
		}
		str += ' <input class ="tnodate" type = "hidden" value = ' + result[i].teamNo+'>'
		str += "</tr>";
    }
   	
		$(".tablebodys").html(str);
   	
   }
	 
</script>
<link rel="stylesheet" href="../css/teamDetail.css">
<link rel="stylesheet" href="../css/teamCurrent.css">