<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<th:block
	th:replace="~{./include/layout :: layout(~{:: .main-wrapper})}">

	<div class="main-wrapper">

		<div class="summaryChartWrap" th:if="${dataMap != null}">

			<div class="chartWrap">

				<div class="barWrap">
					<a href="/board/taskCurrent" class="teamTotal">Â» ì§„í–‰ì¤‘ì¸ í”„ë¡œì íŠ¸: [[${dataMap.teamTotal}]]íŒ€</a>
					<div class="barList">
						<div class="barTitle">â€¢ ì´ íƒœìŠ¤í¬ ìˆ˜ ìƒìœ„ 3íŒ€</div>
						<canvas id="barChart1" style="height: 30vh; width: 10vw"></canvas>
					</div>
					<div class="barList">
						<div class="barTitle">â€¢ ì™„ë£Œ íƒœìŠ¤í¬ ìˆ˜ ìƒìœ„ 3íŒ€</div>
						<canvas id="barChart2" style="height: 30vh; width: 10vw"></canvas>
					</div>
					<div class="barList">
						<div class="barTitle">â€¢ ì§„í–‰ì¤‘ì¸ íƒœìŠ¤í¬ ìˆ˜ ìƒìœ„ 4íŒ€</div>
						<canvas id="barChart3" style="height: 30vh; width: 10vw"></canvas>
					</div>

				</div>

				<div class="doughnutWrap">
					<div class="doughnutTitle">â€¢ ì§„í–‰ì¤‘ì¸ í”„ë¡œì íŠ¸ íƒœìŠ¤í¬ ì „ì²´ í˜„í™©</div>
					<canvas id="doughnutChart" style="height: 40vh; width: 20vw"></canvas>
				</div>

			</div>

		</div>
		
		<div class="summaryNoticeWrap">
		
			<div class="noticeWrap">
			
				<a href="../notice/noticeList" class="noticeTitle">
					âš¹ ê³µì§€ì‚¬í•­ ê´€ë¦¬
				</a>
				
				<table>
					<thead>
						<tr>
							<th style="width: 8%;">ë²ˆí˜¸</th>
							<th style="width: 8%;"></th>
							<th style="width: 34%;">ì œëª©</th>
							<th style="width: 20%;">ì‘ì„±ì</th>
							<th style="width: 30%;">ë“±ë¡ì¼ì‹œ</th>
						</tr>
					</thead>
					<tbody>
						<tr class="noticeRow" th:each="vo, status : ${dataMap.noticeList}">
							<input type="hidden" th:value="${vo.noticeNo}" />
							<td>[[${status.count}]]</td>
							<td><span th:if="${vo.noticeLevel == 'a'}">ğŸ“¢</span></td>
							<td style="text-align: left;">[[${vo.noticeTitle}]]</td>
							<td>[[${vo.userEmail}]]</td>
							<td>[[${#dates.format(vo.noticeRegdate, 'yyyy-MM-dd')}]]</td>
						</tr>
					</tbody>
				</table>
				
			</div>
			
		</div>
		
		<!-- ê³µì§€ì‚¬í•­ ë””í…Œì¼ ëª¨ë‹¬ -->
		<div class="noticeModal">
			<div class="noticeModalBody">
				<div class='noticeModalTitle'></div>

				<div class="contentWrap">

					<div class="infoBox">
						<div class="writer"></div>
						<div class="regdate"></div>
					</div>

					<div class="imgBox">
						<!-- ì´ë¯¸ì§€ ì˜ì—­ -->
					</div>

					<div class="contentBox">
						<!-- ë‚´ìš© ì˜ì—­ -->
					</div>

				</div>

			</div>
		</div>

	</div>

</th:block>

<link rel="stylesheet" href="../css/boardSummary.css">

<script th:inline="javascript">

if(JSON.parse('[[${dataMap}]]') != null){
	// ë„˜ì–´ì˜¨ ë°ì´í„° ë°›ê¸°
	var dataMap = JSON.parse('[[${dataMap}]]');
	
	// 1. íƒœìŠ¤í¬ ìˆ˜ ìƒìœ„ 3íŒ€ ì°¨íŠ¸
	const ctx1 = document.getElementById('barChart1');
	const barChart1 = new Chart(ctx1, {
	    type: 'bar',
	    data: {
	        labels: dataMap.taskCountChart.map(item => item.teamName),
	        datasets: [{
	            data: dataMap.taskCountChart.map(item => item.total),
	            backgroundColor: [
	                'rgba(54, 162, 235, 0.2)',
	                'rgba(255, 206, 86, 0.2)',
	                'rgba(75, 192, 192, 0.2)',
	            ],
	            borderColor: [
	                'rgba(54, 162, 235, 1)',
	                'rgba(255, 206, 86, 1)',
	                'rgba(75, 192, 192, 1)',
	            ],
	            borderWidth: 1
	        }]
	    },
	    options: {
	    	responsive: false,
	        scales: {
	            y: {
	                beginAtZero: true
	            }
	        },
	        plugins:{
	            legend: {
	                display: false
	            },
	        }
	    }
	});
	
	// 2. ì™„ë£Œ íƒœìŠ¤í¬ ìˆ˜ ìƒìœ„ 3íŒ€ ì°¨íŠ¸
	const ctx2 = document.getElementById('barChart2');
	const barChart2 = new Chart(ctx2, {
	    type: 'bar',
	    data: {
	    	labels: dataMap.completeTaskChart.map(item => item.teamName),
	   	    datasets: [{
	    	    data: dataMap.completeTaskChart.map(item => item.complete),
	            backgroundColor: [
	                'rgba(54, 162, 235, 0.2)',
	                'rgba(255, 206, 86, 0.2)',
	                'rgba(75, 192, 192, 0.2)',
	            ],
	            borderColor: [
	                'rgba(54, 162, 235, 1)',
	                'rgba(255, 206, 86, 1)',
	                'rgba(75, 192, 192, 1)',
	            ],
	            borderWidth: 1
	        }]
	    },
	    options: {
	    	responsive: false,
	        scales: {
	            y: {
	                beginAtZero: true
	            }
	        },
	        plugins:{
	            legend: {
	                display: false
	            },
	        }
	    }
	});
	
	// 3. ì§„í–‰ì¤‘ íƒœìŠ¤í¬ ìˆ˜ ìƒìœ„ 3íŒ€
	const ctx3 = document.getElementById('barChart3');
	const barChart3 = new Chart(ctx3, {
	    type: 'bar',
	    data: {
	        labels: dataMap.progressingTaskChart.map(item => item.teamName),
	        datasets: [{
	            data: dataMap.progressingTaskChart.map(item => item.progressing),
	            backgroundColor: [
	                'rgba(54, 162, 235, 0.2)',
	                'rgba(255, 206, 86, 0.2)',
	                'rgba(75, 192, 192, 0.2)',
	                'rgba(255, 159, 64, 0.2)'
	            ],
	            borderColor: [
	                'rgba(54, 162, 235, 1)',
	                'rgba(255, 206, 86, 1)',
	                'rgba(75, 192, 192, 1)',
	                'rgba(255, 159, 64, 1)'
	            ],
	            borderWidth: 1
	        }]
	    },
	    options: {
	    	responsive: false,
	        scales: {
	            y: {
	                beginAtZero: true
	            }
	        },
	        plugins:{
	            legend: {
	                display: false
	            },
	        }
	    }
	});
	
	// 4. ì§„í–‰ì¤‘ í”„ë¡œì íŠ¸ ì „ì²´ í˜„í™©(ë„ë„›ì°¨íŠ¸)
	var doing = 0;
	var todo = 0;
	var done = 0;
	
	dataMap.totalTaskProgress.forEach(n => {
		if(n == 1) doing++;
		else if(n == 2) todo++;
		else done++;
	})
	var total = doing + todo + done;
	
	
	const ctx4 = document.getElementById('doughnutChart');
	const doughnutChart = new Chart(ctx4, {
		  type: 'doughnut',
		    data: {
		      labels: ['ì™„ë£Œ', 'ì§„í–‰ì˜ˆì •', 'ì§„í–‰ì¤‘'],
		      datasets: [{
		        data: [Math.floor((done/total)*100), Math.floor((todo/total)*100), Math.floor((doing/total)*100)],     
		        backgroundColor: [
		        	'rgba(157, 206, 255, 0.8)',
			        'rgba(206, 226, 197, 0.8)',
			        'rgba(251, 197, 197, 0.8)',
		        ],
		        borderWidth: 1,
		        scaleBeginAtZero: true,
		      }
		    ]
		  },
		  options: {
		    	responsive: false,
		    	plugins:{
			        legend: {
			        	display: true,
			        	align: 'end',
			        	reverse: true,
			        	labels: {
			        		padding: 5,
			        		boxWidth: 20,
			        	}
			        },
		        }    
		    }
		});

}

// ê³µì§€ì‚¬í•­ ëª¨ë‹¬
// ë””í…Œì¼ ëª¨ë‹¬ ì„¸íŒ…
$(".noticeRow").click((e) => {
	
	var key = $(e.target).closest('tr').find('input').val();
	
	$.ajax({
		url: "../noticeDetail/"+key,
		type: "get",
		success: (res) => {
			
			console.log(res);
			var date = new Date(res.noticeRegdate);
			
			// í…ìŠ¤íŠ¸
			$('.noticeModalTitle').html("â—‰ " + res.noticeTitle);
			$('.writer').html("ì‘ì„±ì: " + res.userEmail);
			$('.regdate').html("ë“±ë¡ì¼ì‹œ: " + date.getFullYear()+"-"+
										   (date.getMonth()+1)+"-"+
										    date.getDate()+" "+
										    date.getHours()+":"+
										   (date.getMinutes().length == 1 ? "0"+date.getMinutes() : date.getMinutes()));
			$('.contentBox').html(res.noticeContent);
			
			// ì´ë¯¸ì§€
			if(res.fileList != undefined){
				res.fileList.forEach(src => {
					$('.imgBox').append('<img alt="img" src="'+ src +'" style="margin-bottom: 7px;">');
				})
			}
			
			// í‚¤ê°’ ìˆ¨ê¸°ê¸°
			document.querySelector("input[name=noticeNo]").value = res.noticeNo;
			
		},
		error: (err) => {
			console.log("ì—ëŸ¬");
		}
	})
	
	// ë°ì´í„° ì‚½ì… í›„ ëª¨ë‹¬ ì¼œê¸°
	$('.noticeModal').css({'display':'block'});
	
});

//ë””í…Œì¼ ëª¨ë‹¬ ë„ê¸°
$('.noticeModal').click(() => {
	
	// ëª¨ë‹¬ì— ê·¸ë ¤ì§„ ë°ì´í„° ì§€ìš°ê¸°
	$('.imgBox').html('');
	$('.noticeModal').css({'display':'none'});
	
});

</script>